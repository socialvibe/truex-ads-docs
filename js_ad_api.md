# true[X] Javascript API

The true[X] JS API provides a simple method for publishers to integrate true[X] engagement ads on their website.  For server-side implementations there is also a [Web Service API](https://github.com/socialvibe/truex-ads-docs/blob/master/web_service_ad_api.md).

## Terminology
| Term | Definition |
| ------------- | ------------- |
| `engagement`  | The primary rich-media ad unit provided by true[X]. (Examples: Video with interactive features)  |
| `activity`  | Another name for `engagement`.  |
| `network_user_id`  | A partner-provided alphanumeric string uniquely identifying the current user. (If supported, Advertising ID is recommended)  |
| `placement key (aka identifier hash)`  | A unique alphanumeric identifier (generated by true[X]).  Each integrating publisher placement will have their own hash.  |
| `application_key`  | A partner-specific, alphanumeric string (generated by true[X]) used in engagement callback request signing. |
| `application_secret`  | A partner-specific, alphanumeric string (generated by true[X]) used in engagement callback request signing.  Don’t share this value!  |
| `trigger point`  | A call-to-action which allows end-users to 'opt-in' and load the engagement.  |
| `opt in`  | The act of the user clicking on the trigger point to engage with the true[X] activity.  |

## Engagement Flow
The typical engagement flow includes the following steps:
- Publisher makes a request to true[X] to fetch an available activity.
- If available, an activity is returned and the publisher should display a call-to-action for the user to engage with the ad.
- Upon user opt-in, the activity is loaded into a lightbox (or popup window).
- When the user completes the activity, an engagement record is created internally by true[X]. This is recorded after completion regardless of the user closing the activity meaning this event can occur at any while the activity is being interacted with.  The publisher optionally receives a callback (client-side or server-side) indicating the completion.
- The user closes the activity lightbox.

## Usage
In browser:
```html
<script type='text/javascript' src='https://static.truex.com/js/client.js'></script>
```
_NPM package available upon request_

## Setup

Define your `options` hash, initialize `truex.client`, request an activity, and if one is available assign activity event handlers, and then display the trigger point.  When the user clicks the call-to-action, call `client.loadActivityIntoContainer` (perferred method) or `client.openActivityWindow` (pop-up).
```js
var options = {
  network_user_id: "XXX",
  partner_config_hash: "YYY"
};

truex.client(options, function(client) {
  client.requestActivity(function(activity) {
    if (activity) {
      activity.onStart(function(activity){ alert(activity.id + ' start'); });
      activity.onFinish(function(activity){ alert(activity.id + ' finish'); });
      activity.onCredit(function(engagement){ alert(engagement.key + ' credit'); });
      activity.onClose(function(activity){ alert(activity.id + ' close'); });
      activity.onClickthrough(function(url){ alert('clickthrough url: ' + url); });

      client.trackTriggerPointImpression(activity); // signal trigger point is shown
      publisherMethodToDisplayTriggerPoint(activity); // placeholder: display call-to-action
    } else {
      alert('No available activity for this user.');
    }
  });
});
```

## `options` Configuration Parameters
| Parameter | Required | Type | Description |
| ------------- | ------------- | ------------- | ------------- |
| `network_user_id` | ✓ | string | A partner-provided alphanumeric string uniquely identifying the current user. (If supported, Advertising ID is recommended). |
| `partner_config_hash` | ✓ | string | The placement-specific identifier provided by true[X]. |
| `age` |  | int | The user's age.  Used for demographic targeting. |
| `gender` |  | string | The user's gender, represented as 'm' for male, 'f' for female, or 'x' for non-binary.  Used for demo targeting. |
| `dimension_1` |  | string | Slot 1 for targetable metadata. (Example: TV show name) |
| `dimension_2` |  | string | Slot 2 for targetable metadata. |
| `dimension_3` |  | string | Slot 3 for targetable metadata. |
| `dimension_4` |  | string | Slot 4 for targetable metadata. |
| `dimension_5` |  | string | Slot 5 for targetable metadata. |
| `handle_clickthrough_manually` |  | boolean | (mobile only) Handle clickthrough requests manually through a callback. |

## `truex.client` Methods

| Method | Description |
| ------------- | ------------- |
| `requestActivity(callback)` | Makes request for an activity. When request returns, the provided `callback` will be called.  The callback should take one parameter called `activity`.  If not activities are available, `null` will be passed to the callback. |
| `loadActivityIntoContainer(activity, container, options)` | Loads `activity` iframe into the DOM element identified by `container`.  Note that `container` can be an actual DOM element or the id of a DOM element. You may also pass an `options` hash with the following attributes (mobile only): `width`, `height` (accepts % or px values) |
| `openActivityWindow(activity)` | Opens `activity` in a new pop-up window.  Use either this method or `loadActivityIntoContainer` for presenting the activity to the user. |
| `trackTriggerPointImpression(activity)` | This optional method should be called when the trigger point (aka call-to-action) is displayed to the user.  The method allows us to calculate a 'click-through' rate for your placement. |
| `trackOptOut(activity)` | This optional method should be called when a user actively decides not to engage with an activity.  For example, if you have a 'no thanks' or 'close' option in your trigger points.  This is used purely for tracking purposes. |
| `prepareActivity(activity)` | Used in the special case of querying available activities on the server side [Web Service API](https://github.com/socialvibe/truex-ads-docs/blob/master/web_service_ad_api.md) while wanting to use the javascript client for client-side callbacks.  Takes the `activity` object returned from the Web Service API (JSON) and attaches appropriate event handlers for client-side callbacks. |

## `activity` Object
The `activity` object is returned to the `callback` you pass to `requestActivity(callback)`.  The `activity` object has the following event handlers for you to track the lifecycle of the activity:
| Name | Description |
| ------------- | ------------- |
| `onStart` | Triggered when the activity is loaded and the user can begin interacting. |
| `onCredit` | Triggered when the user has spent 30 seconds and interacted at least once with the activity.  This is also known as the 'billing event' because this is when the advertiser is billed and the publisher earns their per-unit payment.  Yields an `engagement` object (see details [below](#engagement-object)). |
| `onClose` | Triggered when the activity window is closed.  This is triggered independently of both `onFinish` and `onCredit`, and can occur even prior to the `onStart` event if the user closes the window prior to the activity fully loading.  Note: It is a best practice to refresh your activity in this event handler, as this will ensure no stale/expired activities are presented to the user. |
| `onFinish` | Triggered when the activity is fully complete and the user has gotten to the end of the activity. |
| `onMessage` | The `onMessage` event handler allows our engagement unit to pass custom messages back to the publisher.  This is only used for special undocumented events. |
| `onError` | Triggered when an error has occurred with the activity. This should be considered an exception.  Its best practice to remove the activity container when this occurs. |
| `onClickthrough` |  (mobile only) Triggered when a clickthrough interaction occurs. Note: this is only triggered when the truex client is constructed with the handle_clickthrough_manually option set to `true`. It is the responsibility of the app to determine how to process the clickthrough URL. A `url` is provided as argument to your event handlers. |

## `engagement` Object
The `engagement` object is returned to the `callback` you pass to the `onCredit(callback)` event handler.  It notifies the publisher that the user has fulfilled the ad requirement and can be rewarded.  It provides the publisher with signature info to authenticate the transaction.
| Attribute | Description |
| ------------- | ------------- |
| `ad` | An object representing the activity with which the user engaged. Can be used to verify the `signature_argument_string`. See the [Engagement Completion Authentication](#engagement-completion-authentication) for further details. |
| `signature` | An authentication digest that is set on successful completion of an engagement.  See the [Engagement Completion Authentication](#engagement-completion-authentication) for further details. |
| `signature_argument_string` | The unique set of attributes that constitute this engagement, represented as a query string.  The engagement signature is a digest of this value.  See the [Engagement Completion Authentication](#engagement-completion-authentication) for further details. |
| `key` | A unique identifier (alphanumerics and the following characters:  ‘.’, ‘-’, ‘_’), that is set on successful completion of an engagement. |
| `completed_at` | An ISO 8601-formatted string representation of the date-time at which this engagement was completed. |
| `message_id` | A unique transaction identifier used for debugging purposes. |

## Engagement Completion Authentication
In order for a publisher to verify the authenticity of an engagement’s completion, the API will assign a signature attribute to the `engagement` object that is yielded to the onCredit event handler.  The publisher should ensure that the signature that they calculate matches that returned from true[X], in addition to ensuring that the engagement key (see [`engagement` Object](#engagement-object)) is unique.

The signature is a digest based on the unique combination of attributes that represent an engagement, and can be calculated as follows (example in Ruby):
```ruby
arg_string  = "activity_id=X&completed_at=X&currency_amount=X&" # newline for clarity
arg_string += "engagement_key=X&network_user_id=X&partner_config_hash=X"
signature = OpenSSL::HMAC.hexdigest('sha256', partner.application_secret, arg_string)
```

Note the following details of this digest calculation:
* The string being digested can be accessed via the `signature_argument_string` property of the the `engagement` object, and contains the following key-value pairs, with keys sorted alphabetically, and formatted as an HTTP query string:
  * creative_id: Accessible in onCredit event handler via: `engagement.ad.creative_id`
  * currency_amount: Accessible in onCredit event handler via: `engagement.ad.currency_amount`
  * completed_at: Accessible in onCredit event handler via:  `engagement.completed_at`
  * engagement_key:  Accessible in onCredit event handler via:  `engagement.key`
  * network_user_id:  Provided by partner, or accessible in onCredit event handler via:  `client.network_user_id`
  * partner_config_hash:  Provided by partner, or accessible in onCredit event handler via:  `client.partner_config_hash`
* The digest method is [HMAC](http://en.wikipedia.org/wiki/HMAC) (Hash-based Message Authentication Code) and uses the SHA256 cryptographic hash function, returning a signature consisting solely of hexadecimal digits.
* The digest is computed using the partner-specific `application_secret`, assigned by true[X], as a symmetric key.
* The digest should be verified on the partner’s server as calculating a digest on the client would imply having the `application_secret` available within the client, which is a dangerous security hole.

## Server-side Callback Specification (optional)
Most partners use client-side callbacks to know when a user has completed an engagement.  This is the recommended callback strategy, and should be sufficient for most use cases.  However, in some configurations, a client-side callback is not possible.  In such configurations, a server-side callback is useful.

In order to leverage server-side callbacks, the partner supplies a callback URL to true[X] during the integration phase.  Upon a user successfully completing an engagement, true[X] will make a request to the partner's callback URL with information about the engagement.  This callback generally happens in real time, but may be delayed depending on current load.  The callback will include the following parameters:
| Parameter | Type | Description |
| ------------- | ------------- | ------------- |
| `application_key` | string | The partner-specific application key provided by true[X]. |
| `network_user_id` | string | The unique, partner-provided user identifier for the user who completed the activity. |
| `currency_amount` | int | The amount of currency earned by completing the activity. |
| `currency_label` | string | The label of the currency used (e.g. "coins"). |
| `revenue` | decimal | The amount of revenue earned by the partner for this engagement. Values can have up to 8 decimal places. |
| `placement_hash` | string | The identifier hash of the placement from which this engagement originated. |
| `campaign_name` | string | The name of the campaign completed in this engagement. |
| `campaign_id` | string | The unique identifier of the campaign completed in this engagement. |
| `creative_name` | string | The name of the creative completed in this engagement. |
| `creative_id` | string | The unique identifier of the creative completed in this engagement. |
| `engagement_id` | string | The unique, true[X]-generated identifier for this engagement.  If a non-unique engagement_id is passed to the partner, the request should be ignored and return a failure code (see below) to avoid over-crediting a user. |
| `sig` | string | The signature of the signed request.  See the [Callback Signing](#callback-signing) section below for details. |

The partner should ensure that the callback URL provides the following response codes:
- 0 – Recoverable failure (request will be retried)
- 1 – Callback successfully processed
- 2 – Invalid signature (this will notify true[X] for investigation)
- 3 – Invalid user or duplicate engagement_id (request will not be retried)

### Callback Signing
In order to protect both true[X] and its publishers from request forgery, all engagement callbacks will be signed using the following algorithm:
1. Put parameters in an array of `key=value` pairs.
2. Order array of parameter pairs in alphabetical order by parameter key.
3. Concatenate parameter pairs into a string.
4. Append the partner-specific `application_secret` provided by true[X] to the string.
5. Calculate a keyed-hash message authentication code (HMAC-SHA1) signature using the partner-specific `application_secret`.
6. URL escape the signature before using it as a query argument.

Sample signature generation using PHP:
```php
<?php
$application_secret = 'XXXXXXXXXXXX';
$args = array(
  'application_key' => 'XXXXXXXXXXXXXXXX',
  'network_user_id' => 'XXXXXXXXXX',
  'currency_amount' => 'XXX',
  'currency_label' => 'XXXX',
  'revenue' => 'XXX.XXXXXXXX',
  'placement_hash' => 'XXXXXXXXXX',
  'creative_name' => 'XXXXXXXXX',
  'creative_id' => 'XXXXXXXXX',
  'engagement_id' => 'XXX'); // Arguments used in the request
ksort($args); // Sort arguments alphabetically

$base_str = '';
foreach ($args as $key => $value) {
  $base_str .= $key . '=' . $value; // Note: there is no separator
}
$base_str .= $secret;
$sig = base64_encode(hash_hmac('sha1', $base_str, $secret, true));
?>
```

### Security
Security and Fraud protection will be handled by:
1. Request Signing (see above)
2. Validation of engagement_id uniqueness.
3. Blocking of all external calls except for those from the following whitelisted IP addresses:
```
50.16.245.107
50.16.245.109
50.16.245.111
184.73.195.45
204.236.225.149
184.73.184.220
174.129.192.205
174.129.193.108 
```


